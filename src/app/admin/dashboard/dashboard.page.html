

<ion-header>
  <ion-toolbar>
    <ion-title>Admin Dashboard</ion-title>
    <ion-buttons slot="end">
      <ion-button id="admin-menu-button" class="menu-button">
        <ion-icon name="chevron-down-outline"></ion-icon>
        Menu
      </ion-button>
      
      <ion-button (click)="navigateToSettings()" class="header-button">
        <ion-icon name="settings-outline" slot="start"></ion-icon>
        Settings
      </ion-button>
      
      <ion-button (click)="logout()" class="header-button">
        <ion-icon name="log-out-outline"></ion-icon>
        Logout
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-popover trigger="admin-menu-button" trigger-action="click" [dismissOnSelect]="true" class="custom-popover">
  <ng-template>
    <ion-content>
      <ion-list>
        <ion-item button (click)="navigateToEvent()" class="popover-item">
          <ion-icon name="calendar-outline" slot="start" color="primary"></ion-icon>
          <ion-label>Event</ion-label>
        </ion-item>
        
        <ion-item button (click)="navigateToAnnouncement()" class="popover-item">
          <ion-icon name="megaphone-outline" slot="start" color="warning"></ion-icon>
          <ion-label>Announcement</ion-label>
        </ion-item>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-popover>

<ion-content class="dashboard-content">
  <!-- Welcome Section -->
  <div class="welcome-section">
    <ion-card *ngIf="user" class="welcome-card">
      <ion-card-header>
        <ion-card-title>Welcome, {{ user.displayName }}!</ion-card-title>
        <ion-card-subtitle>Administrator</ion-card-subtitle>
      </ion-card-header>
      
      <ion-card-content>
        <ion-list lines="none">
          <ion-item class="user-info-item">
            <ion-icon name="shield-checkmark-outline" slot="start" color="primary"></ion-icon>
            <ion-label>
              <h3>Role</h3>
              <p>{{ user.role }}</p>
            </ion-label>
          </ion-item>
          
          <ion-item class="user-info-item">
            <ion-icon name="mail-outline" slot="start"></ion-icon>
            <ion-label>
              <h3>Email</h3>
              <p>{{ user.email }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-section">
    <ion-card class="stats-card">
      <ion-card-header>
        <ion-card-title>System Statistics</ion-card-title>
      </ion-card-header>
      
      <ion-card-content>
        <ion-grid>
          <ion-row>
            <ion-col size="12" size-md="4">
              <div class="stat-card">
                <div class="stat-icon-wrapper">
                  <ion-icon name="people-outline"></ion-icon>
                </div>
                <h2>{{ totalUsers }}</h2>
                <p>Total Users</p>
              </div>
            </ion-col>
            
            <ion-col size="12" size-md="4">
              <div class="stat-card">
                <div class="stat-icon-wrapper">
                  <ion-icon name="shield-outline"></ion-icon>
                </div>
                <h2>{{ adminUsers }}</h2>
                <p>Administrators</p>
              </div>
            </ion-col>
            
            <ion-col size="12" size-md="4">
              <div class="stat-card">
                <div class="stat-icon-wrapper">
                  <ion-icon name="person-outline"></ion-icon>
                </div>
                <h2>{{ residentUsers }}</h2>
                <p>Residents</p>
              </div>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Map and Users Section -->
  <div class="main-content-section">
    <ion-grid>
      <ion-row>
        <!-- Interactive Leaflet Map -->
        <ion-col size="12" size-lg="8">
          <ion-card class="map-card">
            <ion-card-header>
              <ion-card-title>Resident Locations</ion-card-title>
              <ion-card-subtitle>Interactive map with real-time data from {{ residentLocations.length }} sitio</ion-card-subtitle>
              <div class="map-controls">
                <ion-segment [value]="mapView" (ionChange)="onMapViewChange($event)">
                  <ion-segment-button value="streets">
                    <ion-label>Streets</ion-label>
                  </ion-segment-button>
                  <ion-segment-button value="satellite">
                    <ion-label>Satellite</ion-label>
                  </ion-segment-button>
                  <ion-segment-button value="terrain">
                    <ion-label>Terrain</ion-label>
                  </ion-segment-button>
                </ion-segment>
              </div>
            </ion-card-header>
            
            <ion-card-content>
              <!-- Leaflet Map Container -->
              <div #mapContainer class="map-container" id="map"></div>
              <div class="map-legend">
                <div class="legend-item">
                  <div class="legend-color low-density"></div>
                  <span>1-15 Residents</span>
                </div>
                <div class="legend-item">
                  <div class="legend-color medium-density"></div>
                  <span>16-25 Residents</span>
                </div>
                <div class="legend-item">
                  <div class="legend-color high-density"></div>
                  <span>26+ Residents</span>
                </div>
              </div>
            </ion-card-content>
          </ion-card>
        </ion-col>

        <!-- Recent Users -->
        <ion-col size="12" size-lg="4">
          <ion-card class="users-card">
            <ion-card-header>
              <div class="users-header">
                <ion-card-title>Recent Users</ion-card-title>
                <ion-button (click)="navigateToUsers()" class="users-button">
                  <ion-icon name="people-outline"></ion-icon>
                  Manage Users
                </ion-button>
              </div>
            </ion-card-header>
            
            <ion-card-content>
              <ion-list lines="none" class="users-list">
                <ng-container *ngIf="(users$ | async) as users">
                  <ion-item *ngFor="let user of users.slice(0, 5)" class="user-item" button (click)="viewUserDetails(user)">
                    <ion-avatar slot="start" class="user-avatar">
                      <ion-icon name="person-circle-outline"></ion-icon>
                    </ion-avatar>
                    <ion-label>
                      <h2>{{ user.displayName || 'No Name' }}</h2>
                      <p>{{ user.email }}</p>
                      <p *ngIf="user.sitio" class="sitio-text">{{ user.sitio }}</p>
                    </ion-label>
                    <ion-badge [color]="user.role === 'admin' ? 'primary' : 'secondary'" slot="end" class="role-badge">
                      {{ user.role }}
                    </ion-badge>
                  </ion-item>
                  
                  <ion-item *ngIf="users.length === 0" class="no-users-item">
                    <ion-label class="ion-text-center">
                      <p>No users found</p>
                    </ion-label>
                  </ion-item>
                </ng-container>
              </ion-list>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>
</ion-content>

<!-- Map Popup Modal -->
<ion-modal [isOpen]="!!selectedLocation" (ionModalDidDismiss)="selectedLocation = null" class="location-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar color="primary">
        <ion-title>Barangay Poblacion Sitio's Details</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="selectedLocation = null">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
      <div *ngIf="selectedLocation" class="location-details">
        <div class="location-header">
          <ion-icon name="location-outline" color="primary"></ion-icon>
          <h2>{{ selectedLocation.sitio }}</h2>
        </div>
        
        <div class="location-stats">
          <div class="location-stat">
            <h3>{{ selectedLocation.residentCount }}</h3>
            <p>Total Residents</p>
          </div>
          <!-- <div class="location-stat">
            <h3>{{ calculateAverageAge(selectedLocation.residents) }}</h3>
            <p>Average Age</p>
          </div> -->
        </div>
        
        <ion-list>
          <ion-item>
            <ion-label>
              <h3>Coordinates</h3>
              <p>Lat: {{ selectedLocation.lat | number:'1.4-4' }}, Lng: {{ selectedLocation.lng | number:'1.4-4' }}</p>
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-label>
              <h3>Last Updated</h3>
              <p>{{ selectedLocation.lastUpdated | date:'medium' }}</p>
            </ion-label>
          </ion-item>
        </ion-list>

        <!-- Show recent residents from this barangay -->
        <ion-list>
          <ion-list-header>
            <ion-label>Recent Residents in {{ selectedLocation.sitio }}</ion-label>
          </ion-list-header>
          <ion-item *ngFor="let resident of selectedLocation.residents.slice(0, 3)" button (click)="viewUserDetails(resident)">
            <ion-avatar slot="start">
              <ion-icon name="person-circle-outline"></ion-icon>
            </ion-avatar>
            <ion-label>
              <h3>{{ resident.displayName || 'No Name' }}</h3>
              <p>{{ resident.email }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
        
        <ion-button expand="block" (click)="viewResidentsInArea(selectedLocation)" class="view-residents-btn">
          <ion-icon name="list-outline" slot="start"></ion-icon>
          View All {{ selectedLocation.residentCount }} Residents
        </ion-button>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

